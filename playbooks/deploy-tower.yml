---
- name: 'Deploy cloud hosts'
  hosts: local
  roles:
    - { role: deploy_cloud }

- name: 'Add authorized keys on database'
  hosts: 'database'
  roles:
    - role: auth_keys

- name: Configure /etc/hosts to have the proper ipv6 entries
  hosts: tower
  tasks:
    - name: Include hosts role
      include_role:
        name: hosts
      when: awx_ipv6_deployment | default(false) | bool

- name: 'Dynamically create host groups'
  hosts: 'tower'
  tasks:
    - name: group hosts by distribution_major_version
      group_by:
        key: "{{ansible_distribution}}-{{ansible_distribution_major_version}}"
      changed_when: false

- name: Enable FIPS for isolated nodes
  hosts: 'tower'
  tasks:
    - name: Run FIPS Role
      include_role:
        name: fips
      when: "'7.5' in ansible_distribution_version and fips_enabled | default(true) | bool"

- name: 'Install Tower'
  hosts: 'tower'
  gather_facts: no
  become: true
  become_method: sudo
  roles:
    - { role: awx_setup }
