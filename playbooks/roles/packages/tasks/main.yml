---
# Tasks to install awx-setup package-related dependencies on EL systems

- include: rhn.yml
  when: ansible_distribution in ['RedHat']

# Mirrors don't always do the right thing ... retry until the package installs
- name: install epel-release-6
  shell: rpm -q epel-release || rpm -Uvh http://dl.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm
  register: epel_task
  until: epel_task.rc == 0
  when: ansible_distribution in ['RedHat', 'CentOS'] and ansible_distribution_major_version == '6'

# Mirrors don't always do the right thing ... retry until the package installs
- name: install epel-release-7
  shell: rpm -q epel-release || rpm -Uvh http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-2.noarch.rpm
  register: epel_task
  until: epel_task.rc == 0
  when: ansible_distribution in ['RedHat', 'CentOS'] and ansible_distribution_major_version == '7'

- name: update rh-amazon-rhui-client (rhel7 ec2 only)
  yum: name=rh-amazon-rhui-client state=latest
  when: ansible_distribution == 'RedHat' and ansible_distribution_major_version == '7' and ansible_ssh_host.endswith('amazonaws.com')

- name: enable rhui repos (rhel7 ec2 only)
  shell: yum-config-manager --enable '{{item}}' 2>/dev/null
  when: ansible_distribution == 'RedHat' and ansible_distribution_major_version == '7' and ansible_ssh_host.endswith('amazonaws.com')
  with_items:
    - rhui-REGION-rhel-server-optional
    - rhui-REGION-rhel-server-extras

# Install dependencies

- name: install playbook dependency rpms
  yum: name={{item}} state=installed
  with_items:
    - libselinux-python
    - python-pip
    - python-devel
    - autoconf
    - make
    - gcc
  when: ansible_pkg_mgr == 'yum'

- name: install playbook dependency debs
  apt: pkg={{item}} state=latest update_cache=yes
  with_items:
    - python-pycurl
    - python-pip
    - python-dev
    - autoconf
    - make
    - gcc
  when: ansible_pkg_mgr == 'apt'

# install ansible nightly rpm repo (optional)

- name: install ansible nightly yum repository
  template: src=files/ansible_yum.repo.j2 dest=/etc/yum.repos.d/ansible.repo
  register: yum_repo
  when: ansible_pkg_mgr == 'yum' and ansible_install_method == 'nightly'

- name: yum clean cached ansible repository information
  command: yum clean all --disablerepo=* --enablerepo=ansible-nightly
  when: yum_repo is defined and yum_repo.changed

# install ansible nightly rpm repo (optional)

- name: install ansible nightly apt repository
  template: src=files/ansible_apt.repo.j2 dest=/etc/apt/sources.list.d/ansible_repo.list
  when: ansible_pkg_mgr == 'apt' and ansible_install_method == 'nightly'

# install ansible ppa

- name: install ansible stable apt repository
  apt_repository: repo={{ansible_ppa}} state=present
  when: ansible_pkg_mgr == 'apt' and ansible_ppa is defined

# install ansible

- name: install ansible rpm (stable)
  yum: name=ansible state=latest
  when: ansible_pkg_mgr == 'yum' and ansible_install_method == 'stable'

# epel-7 does not support 'epel-testing' repository during beta
- name: install ansible rpm (testing)
  yum: name=ansible enablerepo='*-testing' state=latest
  when: ansible_pkg_mgr == 'yum' and ansible_install_method == 'testing' and ansible_distribution_major_version != '7'

- name: install ansible rpm (nightly)
  yum: name=ansible enablerepo=ansible-nightly state=latest
  when: ansible_pkg_mgr == 'yum' and ansible_install_method == 'nightly'

- name: install ansible deb
  apt: pkg=ansible state=latest update_cache=yes force=yes
  when: ansible_pkg_mgr == 'apt' and ansible_install_method in ['stable', 'testing', 'nightly']

- name: install ansible pip
  pip: name={{ansible_pip}} state=latest
  when: ansible_install_method == 'pip'

- name: verify that ansible was installed
  command: ansible --version
  changed_when: false
