---
- name: create instance(s)
  hosts: local
  roles:
    - role: create_ec2
    - role: create_rds
    - role: save_inventory
      my_inventory_file: '{{inventory_dir}}/inventory.cluster'

- name: Retrieve Public IPs of all instances
  hosts: all
  tasks:
    - ipify_facts:

- name: Enable FIPS for isolated nodes
  hosts: 'tower:isolated_group*:instance_group*'
  tasks:
    - name: Run FIPS Role
      include_role:
        name: fips
      when: "'7.5' in ansible_distribution_version and {{ fips_enabled|default(true) }}"

- name: 'Add authorized keys on non-installer instances'
  hosts: 'tower:instance_group_*:database:haproxy:managed_hosts:!cluster_installer'
  roles:
    - role: auth_keys

- name: 'Group hosts by distribution_major_version'
  hosts: 'tower,instance_group_*'
  tasks:
   - name: group hosts by distribution_major_version
     action: group_by key="{{ansible_distribution}}-{{ansible_distribution_major_version}}"

- name: 'Configure cluster ssh keys'
  hosts: 'tower:instance_group_*:isolated_group_*:database'
  roles:
    - { role: cluster_key_config, install_group: cluster_installer }

- name: 'Install cluster tower on installer instance'
  hosts: 'cluster_installer'
  gather_facts: no
  become: true
  become_method: sudo
  roles:
    - role: awx_setup

- name: 'install and configure haproxy'
  hosts: 'haproxy'
  roles:
    - role: haproxy
  gather_facts: no
  become: true
  become_method: sudo

- name: 'Configure firewall rules for isolated groups'
  hosts: 'isolated_group_protected:managed_hosts'
  become: true
  become_method: sudo
  roles:
    - role: isolated_group_firewall_rules
      when: '{{ awx_apply_isolated_groups_fw_rules | default("true") }}'
