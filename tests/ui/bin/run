#!/usr/bin/env python2

from argparse import ArgumentParser
from subprocess import Popen
import logging
import os


def parse_args():
    parser = ArgumentParser()
    parser.add_argument('-t', '--tower-url', dest='base_url', required=True)
    parser.add_argument('-u', '--username', dest='username', required=True)
    parser.add_argument('-p', '--password', dest='password', required=True)
    parser.add_argument('-v', dest='verbose', action='store_true')
    return parser.parse_args()


if __name__ == '__main__':
    args = parse_args()

    logging.basicConfig(level='DEBUG' if args.verbose else 'INFO')
    log = logging.getLogger()

    env = os.environ
    env.update(dict(AWX_E2E_LAUNCH_URL=args.base_url,
                    AWX_E2E_USERNAME=args.username,
                    AWX_E2E_PASSWORD=args.password))
    dir_path = os.path.dirname(os.path.realpath(__file__))
    project_root = '{}/../'.format(dir_path)
    log.debug('Starting a babel-node run...')
    Popen(['{}/node_modules/babel-cli/bin/babel-node.js'.format(project_root),
           '{}/nightwatch.js'.format(project_root)], env=env).wait()
